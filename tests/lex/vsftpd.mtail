






hidden
text
direction

counter
bytes_transferred
by
direction

counter
transfer_time
by
direction

counter
transfers
by
direction


counter
connects

counter
logins

counter
uploads

counter
commands
by
command

counter
responses
by
response


hidden
gauge
sessions
by
client

counter
session_time


def
vsftpd_timestamp
{


/^\w+\s(?P<date>\w+\s+\d+\s\d+:\d+:\d+\s\d+)/
{

strptime
(
$date
"Jan _2 15:04:05 2006"
)

next

}

}


const
XFERLOG_RE
//
+



/\s(?P<transfertime>\d+)/
+


/\s\d+\.\d+\.\d+\.\d+/
+


/\s(?P<bytestransferred>\d+)/
+


/\s(?P<filename>\S+)/
+



/\s\S/
+


/\s\S/
+


/\s(?P<direction>\S)/
+


/\s\S/
+


/\s\S+/
+


/\s\S+/
+


/\s\d/
+


/\s\S+/
+


/\s(?P<completionstatus>\S)/


const
VSFTPD_LOG_RE
//
+

/ \[pid \d+\]/
+

/( \[\w+\])?/
+

/ (?P<command>CONNECT|OK LOGIN|OK UPLOAD|FTP (command|response)):/
+

/ Client "(?P<client>\d+\.\d+\.\d+\.\d+)"/
+

/(, (?P<payload>.*))?/


const
PAYLOAD_RESPONSE_RE
/^"(\d{3})[" -]/

const
PAYLOAD_COMMAND_RE
/^"(\w{4})[" -]/



@vsftpd_timestamp
{

getfilename
(
)
=~
/xferlog/
{

//
+
XFERLOG_RE
{


$direction
==
"i"
{

direction
=
"incoming"

}

$direction
==
"o"
{

direction
=
"outgoing"

}

$completionstatus
==
"c"
{

transfers
[
direction
]
++

}

transfer_time
[
direction
]
+=
$transfertime

bytes_transferred
[
direction
]
+=
$bytestransferred

}

}


getfilename
(
)
=~
/vsftpd.log/
{

//
+
VSFTPD_LOG_RE
{


$command
==
"CONNECT"
{

sessions
[
$client
]
=
timestamp
(
)

del
sessions
[
$client
]
after
168h

connects++

}

$command
==
"OK LOGIN"
{

logins++

}

$command
==
"OK UPLOAD"
{

uploads++

}

$command
==
"FTP command"
{

$payload
=~
//
+
PAYLOAD_COMMAND_RE
{

commands
[
$1
]
++


$1
==
"QUIT"
{

session_time
+=
timestamp
(
)
-
sessions
[
$client
]

del
sessions
[
$client
]

}

}

}

$command
==
"FTP response"
{

$payload
=~
//
+
PAYLOAD_RESPONSE_RE
{

responses
[
$1
]
++

}

}

}

}

}

